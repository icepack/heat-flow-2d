\documentclass{article}

\usepackage{amsmath}
%\usepackage{amsfonts}
\usepackage{amsthm}
%\usepackage{amssymb}
%\usepackage{mathrsfs}
%\usepackage{fullpage}
%\usepackage{mathptmx}
%\usepackage[varg]{txfonts}
\usepackage{color}
\usepackage[charter]{mathdesign}
\usepackage[pdftex]{graphicx}
%\usepackage{float}
%\usepackage{hyperref}
%\usepackage[modulo, displaymath, mathlines]{lineno}
%\usepackage{setspace}
%\usepackage[titletoc,toc,title]{appendix}
\usepackage{natbib}
\usepackage[makeroom]{cancel}
\usepackage[only,llbracket,rrbracket]{stmaryrd}

%\linenumbers
%\doublespacing

\theoremstyle{definition}
\newtheorem*{defn}{Definition}
\newtheorem*{exm}{Example}

\theoremstyle{plain}
\newtheorem*{thm}{Theorem}
\newtheorem*{lem}{Lemma}
\newtheorem*{prop}{Proposition}
\newtheorem*{cor}{Corollary}

\newcommand{\argmin}{\text{argmin}}
\newcommand{\ud}{\hspace{2pt}\mathrm{d}}
\newcommand{\bs}{\boldsymbol}
\newcommand{\PP}{\mathsf{P}}
\let\divsymb=\div % rename builtin command \div to \divsymb
\renewcommand{\div}[1]{\operatorname{div} #1} % for divergence
\newcommand{\Id}[1]{\operatorname{Id} #1}

\title{Monolothic solution of the coupled mass, momentum, and energy balance of glacier and lava flows}
\author{Daniel R. Shapero, Meghana Ranganathan, Brielle L. Herrin}
\date{}

\begin{document}

\maketitle

\begin{center}
\begin{tabular}{|c|c|c|c|}
    \hline
    variable name & symbol & units & tensor rank \\
    \hline
    energy density & $E$ & kJ m${}^{-3}$ & 0 \\
    velocity & $u$ & m yr${}^{-1}$ & 1 \\
    thickness & $h$ & m & 0 \\
    surface, bed & $s$, $b$ & m & 0 \\
    unit normal vector & $n$ & & 1 \\
    internal heat sources & $Q$ & kJ m${}^{-3}$ yr${}^{-1}$ & 0 \\
    surface, basal mass balance & $\dot a_s$, $\dot a_b$ & m yr${}^{-1}$ & 0 \\
    strain rate & $\dot\varepsilon$ & yr${}^{-1}$ & 2 \\
    membrane stress & $M$ & kJ m${}^{-3}$ & 2 \\
    \hline
\end{tabular}
\end{center}


% ====================
\section{Introduction}

This paper will describe some new approaches to numerical simulation of the thermomechanics of gravity-driven, thin-film, viscous fluid flows.
These types of problems appear all over the geophysical sciences.
J.D. Forbes, who first correctly identified viscous deformation as the mechanism by which glaciers flow, remarked in 1848 that, ``There is something pleasing to the imagination in the unexpected analogy between the icy stream of a glacier and a fiery torrent of lava.''
Both of these systems are extra challenging in that they exchange mass with their environment through phase changes.

Our contributions are as follows.
(1) Conventional approaches to modeling attempt as much as possible to decouple the solvers for different conservation laws by using an operator splitting approach, but this limits the temporal order of accuracy to 1 or at most 2 with special techniques that only work when there are two fields.
We demonstrate an approach to solving for all fields at once using timestepping schemes of order 3 and higher.
(2) Many research software packages work in Cartesian coordinates.
We apply terrain-following coordinates, which have certain advantages in elucidating the coupling between mass and energy balance.
(3) In each of the systems of interest, the thickness of the fluid film can go to zero -- for example in the ablation zone of a glacier, or where a lava flow has thinned and solidified.
The energy balance equation as it is usually written ceases to be well-posed in the limit as the fluid thickness goes to zero.
Here we demonstrate a mixed finite element approach that remains solvable in the zero-thickness limit.
Additionally, we apply specialized discretization based on Bernstein finite elements that preserve non-negativity.

Our main applications of interest are the modeling of both glacier and lava flows.
Both of these systems have nonlinear constitutive relations -- a power law in the case of glaciers and a \textcolor{red}{Bingham plastic?} law for lava.
Glaciers are also assumed to slide over their beds and the sliding law is nonlinear as well.
Our interest here is on the challenge of solving the coupled mass-momentum-energy balance equations with higher-order elements and timestepping.
We instead focus on linear viscous fluids with linear sliding laws.

Finally, we derive a simplified model of heat transport in glaciers that accounts for horizontal advection of thermal energy.
Other phenomenological models used to initialize ice flow simulations instead choose to ignore horizontal transport, but do resolve some of the vertical structure of the temperature field.
For example, \citet{humbert2005parameter} uses a parabolic profile in the vertical and tunes the values to observations from borehole thermometry.
These simplified approaches cannot easily be changed to also incorporate the physics of heat transport.
Most of the heat generated through ice strain in outlet glaciers is ultimately exported out the calving terminus, rather than through either the surface or basal boundary, so including advective transport is a virtual necessity.


% ===============
\section{Physics}

The model that we aim to describe here differs in a few key respects from conventional approaches to simulating coupled heat, mass, and momentum transport.
The conventional approach attempts to decouple as much as possible the heat and mass transport equations because, in many uses of computational fluid mechanics, the system is either closed or of fixed volume.
Geophysical thin-film flows, on the other hand, usually include sources and sinks of mass both at the upper and lower boundaries and at the upstream or downstream boundaries.
For example, ice is advected out of the calving terminus; ice is removed from the base of a floating ice shelf by ocean melt; and ice accumulates at the surface from firn densification.
Lava is extruded above the earth from an erupting volcano, and material is removed from the surface and base by solidification through heat losses to the air and ground.
These are very much open systems and a conventional approach to numerical modeling, which focuses on control volumes that are fixed in space, ignores some of the hard parts.
For example, the densification of ice into firn is a source of mass.
But that mass also carries with it thermal energy.
A conventional numerical modeling approach always accounts for the first but not the second.
The spirit of the physics is captured much better by a discretization approach that is fixed (Eulerian) in the horizontal but moving (Lagrangian) in the vertical.

The full derivation of the model from a conservation law is in the appendix.
Here we present only the variational form that we will work with.
We assume in all cases that the 3D spatial domain is extruded in the vertical dimension from a 2D footprint domain $\Omega$.
So given the bed and surface elevation $b$ and $s$ and a fluid thickness $h = s - b$, the Cartesian vertical coordinate is instead expressed as $z = b + h\zeta$ where $\zeta$ ranges between 0 and 1.
We let $J$ be the derivative of the transformation from terrain-following to Cartesian coordinates and $J^{-1}$ its inverse.

\subsection{Mass balance}

Let $\phi$ be an arbitrary test function.
The variational form of the mass balance equation for the fluid thickness $h$ is
\begin{align}
    0 & = \int_\Omega\left\{\frac{\partial h}{\partial t}\phi - h\bar u\cdot\nabla\phi - (\dot a_s - \dot a_b)\phi\right\}dx \nonumber\\
    & \qquad + \int_{\Gamma_{\text{in}}}h_\Gamma \bar u_\Gamma\cdot n\,\phi\;d\sigma + \int_{\Gamma_{\text{out}}}h\bar u\cdot n\,\phi\;d\sigma
\end{align}
where $\bar u$ denotes the depth-averaged fluid velocity.

\subsection{Momentum balance}

Let $U$ and $L$ be characteristic velocity and length scales for the problem.
We assume that the Reynolds number $\text{Re} = \rho UL/\mu$ is small enough that we can neglect inertial terms in the Navier-Stokes equations.
The Stokes equations in terrain-following coordinates are
\begin{align}
    0 & = \int_\Omega\int_0^1\left\{2 h\mu\,\dot\varepsilon(u):\dot\varepsilon(v) - p\nabla\cdot hv - q\nabla\cdot hu - \rho gh\cdot v\right\}d\zeta\,dx \nonumber\\
    & \qquad\qquad +\int_\Omega \gamma u\cdot v\big|_{\zeta = 0}\,dx
\end{align}
The second summand enforces condition that, along the ice base, $(\tau - pI)\cdot n = -\gamma u$.
This is a Robin boundary condition.
Across the basal interface, the energy balance equation determines the vertical velocity.
The vertical velocity is zero when there are no losses at the fluid base, and is determined by the heat flux supplied to or from the fluid when it is at the melting temperature.
In short, we apply Dirichlet conditions normal to the boundary and Robin boundary conditions in the tangential direction.
The boundary condition at the ice surface is stress-free.

We emphasize that the expression for the strain rate tensor in terrain-following coordinates is not the same as in Cartesian coordinates.
Letting
\begin{equation}
    J = \left[\begin{matrix} I & 0 \\ \nabla b + \zeta\nabla h & h \end{matrix}\right]
\end{equation}
be the derivative of the transformation from terrain-following to Cartesian coordinates, the strain rate tensor is
\begin{equation}
    \dot\varepsilon(u) = \frac{1}{2}\left(\nabla(Ju)J^{-1} + J^{-*}\nabla(Ju)^*\right)
\end{equation}
where all gradients are taken in terrain-following coordinates.

The Stokes equations are the most principled model for momentum balance in the types of problems we consider.
But a number of simplifications are possible.
The ratio of the horizontal to the vertical extent for many geophysical fluid flows is usually on the order of 1/20 or less.
Using a perturbative expansion in the aspect ratio and taking only the lowest-order terms leads to a simpler model.
The terminology for this simpler model varies depending on the discipline; here we refer to it as the first-order model.
It can be obtained by eliminated the $\tau_{12}$ and $\tau_{13}$ terms from the vertical part of the momentum balance equation.
What is left can be rewritten to express the pressure in terms of the surface elevation and the diagonal stress components $\tau_{11}$, $\tau_{22}$.
Additionally, the vertical velocity is eliminated from the problem entirely; it can be calculated again from the boundary condition and the fact that the velocity field is divergence-free.
The variational form of the first-order model is
\begin{align}
    0 & = \int_\Omega\int_0^1\left\{h\mu\dot\varepsilon(u) :\mathscr{C}\dot\varepsilon(v) + h^{-1}\mu\frac{\partial u}{\partial\zeta}\cdot\frac{\partial v}{\partial\zeta} - \rho g(1 - \zeta)\nabla s\cdot v\right\}d\zeta\,dx \nonumber\\
    & \qquad\qquad + \int_\Omega \gamma u\cdot v\big|_{\zeta = 0}\;dx
\end{align}
where $\mathscr{C}$ is a rank-4 tensor such that
\begin{equation}
    \mathscr{C}\dot\varepsilon = \dot\varepsilon + \text{tr}(\dot\varepsilon)I.
\end{equation}
\textcolor{red}{Check factors of 2.}

Finally, the first-order equations can be further simplified by assuming that either horizontal extensional stresses or vertical shear stresses are dominant.
Note that this approximation does not follow from the low aspect ratio -- it is a second perturbative expansion in the parameter $\frac{\partial u}{\partial x} / h^{-1}\frac{\partial u}{\partial\zeta}$.
In either case, we can depth-average the first-order equations to arrive at a 2D equation set for $\bar u$.
When the horizontal stresses dominate, we get an elliptic system of PDEs for the horizontal velocities.
When the vertical stresses dominate, the derivative terms are eliminated completely and we are left with a purely local expression for the depth-averaged velocity in terms of the surface slope.

For modeling lava flow, it is common to assume that the vertical shear stresses dominate.
In glaciology, vertical shear stresses dominate in the interior of ice sheets, while horizontal stresses are most important in fast-flowing ice streams.

\subsection{Energy balance}

Let $\psi$ be an arbitrary test function.
We make the simplifying assumption that diffusive transport of heat is small compared to advective transport in the horizontal directions, i.e. that the P\'eclet number is small.
We do not make this assumption in the vertical dimension, where both effects can be equally important.
The primal variational form of the energy balance equation is
\begin{align}
    0 & = \int_\Omega\int_0^1\left(h\frac{\partial E}{\partial t}\psi - hEu\cdot\nabla\psi + h^{-1}k\frac{\partial T}{\partial\zeta}\frac{\partial\psi}{\partial\zeta} - hQ\psi\right)d\zeta\,dx \nonumber\\
    & \qquad +\int_{\Gamma_{\text{in}}}\int_0^1h_\Gamma E_\Gamma u_\Gamma\cdot n\,\psi\;d\zeta\,d\sigma + \int_{\Gamma_{\text{out}}}\int_0^1 hEu\cdot n\,\psi\;d\zeta\,d\sigma \nonumber \\
    & \quad\qquad + \int_\Omega\left\{\left(\dot a_sE_s - f_s\right)\psi\big|_{\zeta = 1} - \left(\dot a_bE_b - f_b\right)\psi\big|_{\zeta = 0}\right\}\,dx
    \label{eq:energy-balance}
\end{align}
The final integral is the flux of thermal energy into the system at the fluid surface and base.
These include fluxes due to accumulation or ablation of material (the $\dot a_sE_s$ and $\dot a_bE_b$ terms) and conductive or radiative fluxes at either surface ($f_s$, $f_b$).
These fluxes have to be known functions of the state of the medium and its exterior but are problem-dependent.
We describe the different cases below.
The important and general point in all cases is that \textbf{the energy balance at the surface and base of the fluid affects the net mass balance} whenever the temperature is close to the melting point.

We have used the internal energy $E$ of the medium as the field variable instead of the temperature $T$ in order to better handle phase changes.
Once a material reaches its melting point, the addition of heat no longer raises its temperature but instead contributes to the latent heat necessary to change phase.
Using the temperature as a field variable would require the introduction of an additional variable in order to handle phase transitions.
We assume that the specific heat capacity of the medium is a constant throughout the temperature range of interest, in which case the energy density is
\begin{equation}
    E = \rho(c_pT + Lm)
\end{equation}
where $m$ is the fraction of material of the other phase (solid rock for lava flows, water for ice).
We can then invert this relation to write the temperature as
\begin{equation}
    T = \min\{T_m, E/\rho c_p\}.
\end{equation}
Phase change can result in mass gains or losses.
For example, consider a floating ice shelf in thermal contact with the ocean or a lake.
If the water is sufficiently warm and salty then it can melt away at the bottom of the ice shelf.
But if the bulk of the water mass was mostly near 0${}^\circ$C then it can instead freeze onto the bottom of the shelf.
Likewise, lava cools upon contact with the ground underneath it, and ordinarily it will solidify.
Although this is rare \textcolor{red}{cite}, it can also be hot enough to melt the ground, and this liquified material then flows downstream.

Mathematically, there are two cases to consider: (1) the fluid medium only reaches the melting temperature at the boundary, and the temperature gradient at the boundary is non-zero, and (2) the fluid medium is at the melting point over a finite interval, and thus the temperature gradient at the boundary is equal to zero.
In the first case, the exterior is undergoing phase changes and the fluid medium is gaining mass; in the second case, the fluid medium is undergoing phase changes and is losing mass.

Consider just the fluid base for now.
Heat flux balance gives
\begin{equation}
    \rho L\dot a_b = h^{-1}k\partial_\zeta T + f_b + \gamma|u|^2
\end{equation}
where $f_b$ is the external heat flux.
(If we know the temperature in the external medium, then $f_b = -k_\Gamma\nabla T_\Gamma\cdot n$.)
The final term accounts for heat from sliding friction.
Remember that for melting of ice the temperature gradient is negative and the heat flux is positive, while for lava flow the temperature gradient is positive and the heat flux is negative.
In both cases, when the temperature gradient in the fluid is non-zero, some of the heat energy is used to change the temperature of the fluid and thus reduces the rate of phase change.
When the temperature gradient in the fluid is zero, all of the heat energy at the boundary goes to phase change.

Lava cools down by radiating heat away to the atmosphere; the Stefan-Boltzmann law then says that
\begin{equation}
    f_s = \sigma(T^4 - T_s^4)
\end{equation}
where $T_s$ is the atmospheric temperature and $\sigma$ is the Stefan-Boltzmann constant.
However, when the surface cools rapidly enough as to solidify, this solid crust then acts as a thermal insulator.
The insulation of the solid crust is what makes it possible for lava flows to extend as long as they do.
\textcolor{red}{Find a citation for this.}

Whether the bed or surface elevation can change in time depends on the medium.
Ignoring the effect of erosion, the bed elevation does not change for a grounded glacier, but the surface elevation does.
An ice shelf that floats on the ocean, however, can gain or lose mass at its base.
A lava flow loses mass by solidification at the base and the surface.

The diffusive part of the variational form in equation \eqref{eq:energy-balance} is proportional to $h^{-1}$.
This term is singular when the fluid thickness goes to zero.
Mathematically, the singularity is removable because the vertical derivatives of the solution should also go to zero.
But this singularity becomes a total disaster in floating-point arithmetic.
Here we apply an approach that we used in \textcolor{red}{cite the duality paper}.
Introducing the heat flux $F$ explicitly as an unknown into the problem, we can add another equation as well:
\begin{equation}
    hk^{-1}F + \partial_\zeta T(E) = 0.
\end{equation}
This equation is still finite even when the fluid thickness goes to zero.
The resulting equation set is more expensive but the expense can be worth it if it avoids having to use other approaches such as regularization.


% ======================
\section{Discretization}

\subsection{Spatial}

We use continuous Galerkin finite elements for the velocity space since the momentum balance equation is an elliptic problem.
The mass balance equation, viewed in isolation with the velocity as an input, is hyperbolic, so we use a discontinuous Galerkin basis for its superior stability and non-oscillation properties compared to continuous elements.
We found in \textcolor{red}{cite the duality paper} that, for a related problem, using CG elements for the thickness gave a solution with obvious oscillatory artifacts while using DG elements did not.

The energy balance equation is of mixed hyperbolic-parabolic type.
Here we used DG elements as well but with a symmetric interior penalty approach to discretize the diffusive part of the operator.
\textcolor{red}{Something about energy/flux element pairs...}

We also have to make choices about whether to use higher-order finite elements and fewer vertical layers, or lower-order elements and more vertical layers.
When the solution is known to be smooth, higher-order elements offer greater accuracy for the same number of degrees of freedom.
But real scenarios may have non-smooth solutions, for example when the temperature nears the melting point.
Additionally, the constitutive law for ice has a discontinuity in its 1st derivative around a transition temperature of -10${}^\circ$C.
Attempting to use high-order polynomials to interpolate this field can result in spurious values that go outside the known range or even go negative.
In these circumstances, we can instead use a multi-layer model.
Mass is exchanged among layers according to their temperature range, so for example we might use one layer to represent ice that is below the melting point or lava that is above, and another layer to represent fluid that is at the melting point and awaiting enough latent heat for the transition to another phase.

In addition to the coupled balance equations, the film thickness must also remain positive.
The common approach to maintaining positivity in glacier flow models is to solve the mass balance equation separately, allowing for the possibility that the thickness may go negative.
The thickness field is then clamped below at 0.
This clamping approach introduces a positive mass conservation error.
\citet{bueler2021conservation} has instead proposed an approach based on directly imposing this constraint as a variational inequality or complementarity problem.
This approach works for \textcolor{red}{DG(0) and CG(1)} finite elements because there is a direct relationship between positivity of the coefficients in this basis and the positivity of the function.
This relationship no longer exists for higher-degree finite elements using the usual Lagrange basis.

\citet{kirby2024high} proposed using the Bernstein instead of the Lagrange finite element basis for positivity-constrained problems.
If the coefficients of a polynomial in the Bernstein basis are positive, then so is the polynomial.
The converse is not true for any particular mesh but it becomes true in the limit of mesh refinement.
Here we explore using both Lagrange and Bernstein finite elements and evaluate the effect on the solution.
\textcolor{red}{Elaborate...}


\subsection{Temporal}

The problem of interest here is a very dissipative differential-algebraic equation.
This type of problem calls for an L-stable timestepping scheme.
The prototypical L-stable scheme is backward Euler.
Here we also apply the Radau-IIA time discretization, of which the backward Euler scheme is the lowest-order variant.
The Radau-IIA($k$) scheme is of order $2k - 1$ and is stiffly accurate \citep{hairer1996solving}.

We additionally apply the Bernstein-in-time collocation to ensure positivity throughout the whole time interval.
\textcolor{red}{Elaborate}.



% ======================
\section{Demonstrations}

\subsection{Verification}

We first test our implementation on several analytically solvable test cases.
Our initial test cases are much simpler than the norm for a verification exercise.
We argue that the difficulty of modeling phase change in open systems necessitates starting at a more basic level than is common for numerical modeling of other problem, such as single-phase fluid flow in a fixed geometry.

\subsubsection{Growing fluid column}
Our first test case does not involve any transport at all but rather a column of fluid that is growing at a fixed rate $\dot a$.
The fluid has an initial internal energy $E_0$.
The mass and energy balance equations are
\begin{align}
    \partial_t h & = \dot a \\
    h\partial_t \bar E & = \dot a E_{\dot a}
\end{align}
but if we multiply the mass balance equation by $E$ and add the two together we get
\begin{equation}
    \partial_t(h\bar E) = \dot a(\bar E + E_{\dot a})
\end{equation}

\subsubsection{Steady advection in 2D}
Now we consider a case with horizontal advection of heat using a fixed velocity field.
We take
\begin{equation}
    u = \left(\begin{matrix}u_0 + \delta u\cdot x / L \\ -\delta u \cdot z / L\end{matrix}\right)
\end{equation}
which is divergence-free.
We leave out diffusion for this test case so that we can write down an analytical solution using the method of characteristics.
In order to maintain the free surface at a steady state, we require an accumulation rate of $\dot a = \delta u \cdot H / L$.

\subsubsection{Steady phase change in 1D}
The next test case assesses the ability of the model to handle a phase transition within the fluid column.
We work from the example in section \S9.3.6 of \citet{greve2009dynamics}.
This example is described in the book specifically for glacier flow using Glen's flow law with $n = 3$.
The problem setup makes several simplifications, to the extent that the constitutive law is relevant only in the form of the strain heating term.
Consequently, we assume the right-hand side is some generic non-negative function and only put in a particular choice at the end.
The original problem also assumes a fixed temperature at the fluid surface.
We assume a known flux instead.
In all other respects the form of the solution we use is identical.

The setup for the test case is follows.
Heat flow is only in the vertical direction.
Accumulation occurs at the fluid surface and ablation at the base, so the vertical velocity is negative.
The material parameters (thermal conductivity, etc.) are all assumed constant.
The fluid is subject to given fluxes at the surface and base and volumetric heating $Q$, which we assume is a known positive function.
The differential form of the steady vertical advection-diffusion equation is
\begin{equation}
    \frac{\partial}{\partial\zeta} \left(h\omega E - h^{-1}\kappa(E)\frac{\partial E}{\partial\zeta}\right) = hQ.
\end{equation}
The surface boundary condition is
\begin{equation}
    h\omega E - h^{-1}\kappa(E)\frac{\partial E}{\partial\zeta} = f_s.
\end{equation}
We assume additionally that the surface flux can be written as downward advection of material with some internal energy $E_s$, which we assume to be less than the melting temperature:
\begin{equation}
    f_s = h\omega E_s \textcolor{red}{+ \frac{\kappa}{h\lambda}(E - E_a)}
\end{equation}
\textcolor{red}{and we should probably also see what happens if we use a Robin-type boundary condition with some skin depth $\lambda$.}
The basal boundary condition, accounting for energy jumps, is
\begin{equation}
    -\rho Lh\omega = f_b
\end{equation}
which defines the vertical velocity.
The ODE and two boundary conditions would be enough for a complete specification of the problem in ordinary circumstances.
Here we are instead solving a free boundary problem where we also have to determine the cold-temperate transition depth $\zeta_m$.
We assume that the energy is continuous at the cold-temperate transition (i.e. we consider the melting case of the problem in \citet{greve2009dynamics} and not the freezing case).
This means that
\begin{equation}
    E(\zeta_m^+) = E(\zeta_m^-) = \rho cT_m.
\end{equation}
We also require the flux to be continuous across the transition.
In the temperate part of the fluid column, the diffusivity is zero.
Since the energy values on either side of the free boundary are the same, we are left with
\begin{equation}
    -h^{-1}\kappa\frac{\partial E}{\partial\zeta}\Big|_{\zeta_m^+} = 0.
\end{equation}
These additional interior conditions complete the specification of the problem.

We'll start by finding the form of the energy above $\zeta_m$.
Integrating from the surface down and rearranging terms, we first find that
\begin{equation}
    h\omega E - h^{-1}\kappa\frac{\partial E}{\partial\zeta} = f_s - \int_\zeta^1 hQ(\zeta')d\zeta'
\end{equation}
We introduce the integrating factor $\phi = \frac{h^2\omega}{\kappa}(\zeta - \zeta_m)$ to write
\begin{equation}
    e^{\phi}\frac{\partial}{\partial\zeta}e^{-\phi}E = \kappa^{-1}h\left(\int_\zeta^1hQ(\zeta')d\zeta' - f_s\right).
\end{equation}
Knowing that $E(\zeta_m^+) = E_m$, we can then integrate again from $\zeta_m$ up to an arbitrary depth $\zeta$:
\begin{equation}
    E(\zeta) = e^{\phi(\zeta)}E_m + \kappa^{-1}h\int_{\zeta_m}^\zeta e^{\phi(\zeta) -\phi(\zeta')}\left(\int_{\zeta'}^1h Q(\zeta'')d\zeta'' - f_s\right)d\zeta'.
    \label{eq:greve-solution}
\end{equation}
Our choice of integrating factors guarantee that $E$ satisfies the surface flux boundary condition and the melt condition $E(\zeta_m) = E_m$.

The final problem is to find what depth $\zeta_m$ makes $h^{-1}\kappa\partial_\zeta E(\zeta_m) = 0$.
From equation \eqref{eq:greve-solution}, the conductive heat flux above the transition depth is
\begin{equation}
    h^{-1}\kappa\frac{\partial E}{\partial\zeta}\Big|_{\zeta = \zeta_m} = h\omega E_m - f + h\int_{\zeta_m}^1Q(\zeta)d\zeta.
\end{equation}
Recall that the surface flux $f_s$ is equal to $h\omega E_s$.
Requiring the conductive heat flux to be zero at the transition depth thus has a simple physical interpretation for what determines $\zeta_m$.
The fluid is cold until strain heating supplies enough thermal energy to raise the temperature from the surface value $E_s$ up to the melting point $E_m$:
\begin{equation}
    \int_{\zeta_m}^1Q(\zeta)d\zeta = \omega(E_s - E_m)
\end{equation}
We can then solve this equation numerically for $\zeta_m$.
A phase transition occurs within the fluid column if the solution $\zeta_m$ is positive, which may or may not occur depending on the magnitudes of the input parameters.
For example, if there is no volumetric heating, then no phase transition will occur.

We assumed accumulation at the surface, ablation at the base, and a negative vertical velocity in the above.
This scenario would be representative of a grounded glacier that melts from below.
Almost all of the above applies just as well when we look at lava flow, where mass is instead extruded up from the base and ablates by solidification at the surface.

\subsubsection{Seasonal variation}
Here we assume a fluid column with ablation at the base and seasonally-varying accumulation at the surface.
The mass conservation equation is
\begin{equation}
    \partial_th = \dot a - \dot m
\end{equation}
where the accumulation rate $\dot a$ is an input we can pick and the melt rate $\dot m$ is computed from the basal boundary condition of the energy balance equation.
The energy balance equation is
\begin{equation}
    h\partial_t E + \partial_\zeta hE\omega - \partial_\zeta h^{-1}k\partial_\zeta T = 0.
\end{equation}
The surface boundary condition is
\begin{equation}
    hE\omega - h^{-1}k\partial_\zeta T\Big|_{\zeta = 1} = \dot aE_{\dot a}.
\end{equation}
The basal boundary condition is
\begin{equation}
    hE\omega - h^{-1}k\partial_\zeta T\Big|_{\zeta = 0} = q
\end{equation}
and finally
\begin{equation}
    h\omega = \begin{cases}0 & T < T_m \\ q/\rho L & T = T_m\end{cases}
\end{equation}

We pick the accumulation rate to be a periodic function of time:
\begin{equation}
    \dot a = \dot a_0 + \delta\dot a\cdot\cos(2\pi t).
\end{equation}
For the system to approach some steady limit cycle, we need the basal flux to supply enough heat to melt all the fluid that is accumulated at the surface:
\begin{equation}
    q = \dot a_0 E_{\dot a} / \rho L
\end{equation}
where $\rho$ is the material density and $L$ the latent heat of melting \textcolor{red}{the units are wrong but it's something like this}.

\subsubsection{Axisymmetric heat conduction with free boundaries}

Our next test case is to evaluate the heat flow solver when the film thickness can go to zero.
In particular, we want to test that the computed temperature in fluid-free regions is equal to a weighted average of the external temperatures from the radiation boundary conditions.
We assume that:
\begin{enumerate}
    \item The system is in steady state.
    \item The problem is axisymmetric -- all fields depend only on the radial coordinate $r$.
    \item The longitudinal components ($x-x$, $x-y$, $y-y$) of the strain rate tensor are negligible; only the $x-z$ and $y-z$ components matter.
    \item We get to prescribe the volume flux $Q$, which equals 0 near the origin, increases to some positive value, and then goes to 0 again at some radius $R$.
    \item The boundary condition on the thickness is that $h(R) = 0$.
\end{enumerate}
With these assumptions, we expect a steady-state profile that looks like a dome.
The radial limit of the fluid film $R$ might be computable analytically or numerically depending on what flux function we choose.
We can back out the accumulation and ablation rates from a prescribed volume flux using the relation $\nabla\cdot Q = \dot a$.

The fluid velocity is a purely local function of the surface slope and thickness when we assume that the longitudinal components of the strain rate tensor are negligible:
\begin{equation}
    u = -K\rho gh\nabla h.
\end{equation}
Assuming that we know the volume flux $Q$, we then get
\begin{equation}
    Q = hu = -K\rho gh^2\nabla h = -\frac{1}{3}K\rho g\nabla h^3.
\end{equation}
The problem is axisymmetric, so the gradient can be replaced with $\partial/\partial r$.
If we integrate in $r$ and apply the boundary condition that $h(R) = 0$, we find that
\begin{equation}
    h(r)^3 = \int_r^R\frac{3Q(r')}{K\rho g}dr'.
\end{equation}

Now we can take the simplest choice of volume flux that satisfies the conditions $Q(0) = Q(R) = 0$ and $Q \ge 0$ inside this radius, namely
\begin{equation}
    Q = 4q_0\frac{r}{R}\left(1 - \frac{r}{R}\right)
\end{equation}
for some baseline flux $q_0$.
The factor of 4 makes the volume flux exactly equal to $q_0$ at $r = R / 2$.
We then find that
\begin{equation}
    h(r)^3 = \frac{2q_0R}{K\rho g}\left(1 - 3\left(\frac{r}{R}\right)^2 + 2\left(\frac{r}{R}\right)^3\right).
\end{equation}

\subsection{Mass-momentum balance}

Our first test case is to evaluate our solver for the coupled mass and momentum balance without accounted for thermal effects yet.
Here we compare two numerical setups: (1) a splitting method, which alternates separate updates of the mass and momentum balance equations, and (2) a monolithic method which updates both simultaneously.

\subsection{Thermally-coupled problem}

Next we add heat flow to the problem.
First, we assume that the fluid velocity affects the temperature through advection and strain heating, but otherwise the momentum balance equation does not depend on temperature.
This first exercise is to see if we can effectively simulate the coupled mass-momentum-energy balance problem when the ice thickness can go to zero.

Then we add temperature-dependence to the viscosity coefficient.

\subsection{Phase changes}

Finally, we consider a thermally-coupled problem with phase changes at the surface and base.
Here we consider several cases which are or are not relevant depending on the medium.
For glacier flow, when ice melts at the base, we assume that the liquid water is instantly transported into the subglacial drainage system.
For lava, on the other hand, solidification at the base alters the topography that the lava flows over.


\pagebreak

% ===================
\appendix
\section{Derivations}

% ----------------------------
\subsection{Conservation laws}

Let $\phi$ be the density per unit mass of some conserved quantity and suppose that the medium has a bulk velocity $u$.
Now let $\omega$ be an arbitrary control volume within the spatial domain $\Omega$.
It is customary to assume that $\omega$ is fixed in time; here we will instead assume that the boundary of $\omega$ is moving at some speed $v$.
We emphasize that the bulk velocity of the medium need not be the same as the velocity of the control volume boundary.
The general form of a conservation law for $\phi$ is
\begin{equation}
    \frac{d}{dt}\int_\omega \rho\phi\;dx + \int_{\partial\omega}\left\{\rho\phi (u - v) + F\right\}\cdot n\; d\sigma = \int_{\partial\omega\cap\partial\Omega}f\cdot n\;d\sigma + \int_\omega q\;dx
\end{equation}
where $F$ is the non-advective flux of $\phi$, $f$ are the fluxes from the boundaries of the domain, $q$ are the volumetric sources.
In a fixed or purely Eulerian reference frame, the control volumes do not move at all, i.e. $v = 0$.
In a material or purely Lagrangian reference frame, the control volumes move with the material, i.e. $v = u$, which eliminates the advective fluxes entirely.

For conservation laws in either a purely fixed or material reference frame, there is a rote procedure to derive a variational form.
We will describe the case of a fixed reference frame first.
Let $\psi$ be an arbitrary test function.
Consider the control volume $\omega = \{x \in \Omega : \psi(x) \ge \alpha\}$, i.e. the super-level set of $\psi$.
As a shorthand we will write this as $\{\psi \ge \alpha\}$.
The boundary of this set is $\{\psi = \alpha\}$ and the outward-pointing normal vector is $n = -\nabla \psi/|\nabla \psi|$.
The conservation law then gives
\begin{align}
    & \frac{d}{dt}\int_{\{\psi \ge \alpha\}}\rho\phi\;dx - \int_{\{\psi = \alpha\}}\left\{\rho\phi u + F\right\}\cdot \frac{\nabla\psi}{|\nabla\psi|}\;d\sigma \nonumber\\
    & \qquad\qquad\qquad = \int_{\{\psi \ge \alpha\}\cap\partial\Omega}f\cdot n\;d\sigma + \int_{\{\psi \ge \alpha\}}q\;dx \label{eq:conservation-law-superlevel-set}
\end{align}
Next, we integrate both sides of the previous equation with respect to $\alpha$ and interchange the time derivative and the integral:
\begin{align}
    & \frac{d}{dt}\int_{-\infty}^\infty\int_{\{\psi \ge \alpha\}}\rho\phi\;dx\,d\alpha - \int_{-\infty}^\infty\int_{\{\psi = \alpha\}}\left\{\rho\phi u + F\right\}\cdot \frac{\nabla\psi}{|\nabla\psi|}\;d\sigma\;d\alpha \nonumber\\
    & \qquad\qquad\qquad = \int_{-\infty}^\infty\int_{\{\psi\ge\alpha\}\cap\partial\Omega}f\cdot n\;d\sigma\;d\alpha + \int_{-\infty}^\infty\int_{\{\psi \ge \alpha\}}q\;dx\;d\alpha
\end{align}
The real crux of the argument is to rewrite everything with the help of the \emph{area} and the \emph{co-area} formulas.
The area formula states that, for any integrable function $g$,
\begin{equation}
    \int_\Omega g\psi\;dx = \int_{-\infty}^\infty\int_{\{\psi\ge\alpha\}}g\;dx\;d\alpha.
\end{equation}
The co-area formula states that, for any integrable vector field $v$,
\begin{equation}
    \int_\Omega g|\nabla\psi|\;dx = -\int_{-\infty}^\infty\int_{\{\psi=\alpha\}}g\;d\sigma\;d\alpha.
\end{equation}
The application of the area formula is straightforward.
To apply the co-area formula, we take $g = (\rho\phi u + F)\cdot\nabla\psi / |\nabla\psi|$.
Finally, we can move the time derivative under the integral sign because we assume (for now) that $\psi$ does not change in time.
We then arrive at the usual variational form
\begin{align}
    & \int_\Omega\left(\frac{\partial}{\partial t}(\rho \phi)\cdot \psi - (\rho \phi u + F)\cdot\nabla\psi\right)dx \nonumber\\
    & \qquad\qquad = \int_\Omega q\,\psi\;dx + \int_{\partial\Omega}f\cdot n\;\psi\;d\sigma.
\end{align}

All of the argument above assumed that the control volumes are fixed in space.
We can go through the same procedure when the control volumes are material elements, i.e. $u = v$ everywhere.
What happens when $v$ is not zero, but also not equal to $u$?
Here almost the entire argument is the same as before, we just have to observe that
\begin{equation}
    \frac{d}{dt}\int_\omega\rho\phi\;dx = \int_\omega\frac{\partial}{\partial t}(\rho\phi)\;dx + \int_{\partial\omega}\rho\phi\,v\cdot n\;d\sigma.
\end{equation}
(To get some intuition for this formula, you can first imagine a density that does not change in space or time, but with a growing control volume.)
If we apply this expression and interchange the time derivative and integral before equation \eqref{eq:conservation-law-superlevel-set}, then we end up at the same variational form.


% ----------------------------------------
\subsection{Terrain-following coordinates}

First, we will describe general curvilinear coordinate systems, and then introduce terrain-following coordinates.
We use $x$ to denote Cartesian coordinates and $\xi$ to denote the curvilinear coordinate systemand we assume that the two can be expressed as functions of each other, so that $x = x(\xi)$ and $\xi = \xi(x)$.
We let
\begin{equation}
    J = \frac{dx}{d\xi}
\end{equation}
be the derivative of the transformation from curvilinear to Cartesian coordinates and $J^{-1} = d\xi/dx$ the inverse.
To express a problem in another coordinate system, we need to (1) describe how vector and tensor fields and derivatives transform, and (2) how integrals transform.

Let $u_x$ be the velocity field in Cartesian coordinates and $u_\xi$ the the velocity in curvilinear coordinates.
These vector fields are derivatives of trajectories in space, so that $u_x = dx/dt$ and $u_\xi = d\xi/dt$.
The chain rule then gives
\begin{equation}
    u_x = \frac{dx}{dt} = \frac{dx}{d\xi}\frac{d\xi}{dt} = Ju_\xi.
\end{equation}
Now if $\phi$ is some field then the chain rule also tells us that its differential is
\begin{equation}
    \frac{d\phi}{dx} = \frac{d\phi}{d\xi}\frac{d\xi}{dx} = \frac{d\phi}{d\xi}J^{-1}.
\end{equation}
In other words, vector fields transform contravariantly (multiplication on the left by $J$) while derivatives transform covariantly (multiplication on the right by $J^{-1}$).
The expression for higher-rank tensors becomes more complicated.
By systematically applying the rules for transformation of vectors and derivatives, the strain rate tensor becomes
\begin{align}
    \dot\varepsilon_x & = \frac{1}{2}\left(\nabla_xu_x + \nabla_xu_x^*\right) \nonumber \\
    & = \frac{1}{2}\left(\nabla_\xi(Ju_\xi)J^{-1} + J^{-*}\nabla_\xi(Ju_\xi)^*\right)
\end{align}
in curvilinear coordinates.
Finally, any integrals with respect to $dx$ become integrals with respect to $\det J\;d\xi$.

Terrain-following coordinates are a particular choice of curvilinear coordinate system that we can use in certain geometries.
In free-surface fluid flows, the spatial domain can be described as
\begin{equation}
    \Omega = \{(x, z) : x \in \Phi, b(x) \le z \le s(x)\}
\end{equation}
for some 2D footprint domain $\Phi$.
The terrain-following coordinates are defined as
\begin{equation}
    \left(\begin{matrix}\xi_1 \\ \xi_2 \\ \xi_3\end{matrix}\right) = \left(\begin{matrix} x_1 \\ x_2 \\ \frac{x_3 - b(x_1, x_2)}{h(x_1, x_2)}\end{matrix}\right).
\end{equation}
We can then write the reverse transformation as
\begin{equation}
    \left(\begin{matrix} x_1 \\ x_2 \\ x_3\end{matrix}\right) = \left(\begin{matrix}\xi_1 \\ \xi_2 \\ b(\xi_1, \xi_2) + h(\xi_1, \xi_2)\xi_3\end{matrix}\right).
\end{equation}
In Cartesian coordinates, $x_3$ ranges over the values $b(x_1, x_2)$ and $s(x_1, x_2)$, which vary from point to point.
In terrain-following coordinates, however, $\xi_3$ ranges from 0 to 1 everywhere.
We can thus write the image of $\Omega$ under the curvilinear coordinate transformation as the Cartesian product of the footprint domain $\Phi$ and the interval $[0, 1]$.
Now we can calculate the derivatives explicitly:
\begin{align}
    J & = \frac{dx}{d\xi} = \left[\begin{matrix}I & 0 \\ \nabla b + \xi_3\nabla h & h\end{matrix}\right] \\
    J^{-1} & = \frac{d\xi}{dx} = \left[\begin{matrix} I & 0 \\ -h^{-1}\{\nabla b - \xi_3\nabla h\} & h^{-1}\end{matrix}\right]
\end{align}
A few things are worth noting here.
First, the right weighting factor to put in any integrals is $\det J = h$.
Next, the final row of $J^{-1}$ has factors of $h^{-1}$.
The fact that these terms are singular in the limit of zero fluid thickness will motivate some of our later choices.
Finally, since both $b$ and $h$ only depend on the horizontal coordinates, we can write ``$\nabla b$'' and ``$\nabla h$'' without a subscript to specify which coordinate system we're taking the gradient in because their expressions are the same in both.

Now we can rewrite the expression for the energy balance equation in terrain-following coordinates:
\begin{align}
    0 & = \int_\Phi\int_0^1 h\left\{\frac{\partial E}{\partial t}\phi - Eu\cdot\nabla\phi + k\nabla T\cdot J^{-1}J^{-*}\nabla\phi - Q\phi\right\}d\zeta\,dx \\
    & \qquad - \int_\Phi\dot aE_{\dot a}\phi\Big|_{\zeta=1} dx + \int_\Phi\dot mE_{\dot m}\phi\Big|_{\zeta = 0}dx + \int_{\partial\Phi}\int_0^1 hEu\cdot n\;\phi\;d\zeta\,d\sigma.
\end{align}
The effect of the terrain-following coordinates is to introduce an extra weighting factor of $h$ and to change the diffusive term.
The result still looks similar to the usual convection-diffusion equation, but with an anisotropic diffusivity term.


\pagebreak

\bibliographystyle{plainnat}
\bibliography{heat-flow.bib}

\end{document}
